# 宏任务与微任务

## 为什么区分宏任务与微任务

JS 引擎是单线程的，如果将全部任务都放到一个队列中会造成阻塞，例如比较耗时的操作，区分宏任务和微任务可以避免队列的阻塞

## 分类

1. 宏任务：定时器、MessageChannel、I/O 与事件队列、script（整体代码块）、setImmediate（Node 环境）
2. 微任务：Promise（then/catch/finally，注意不包含 pending 状态）、MutationObserver（浏览器环境）、process.nextTick（Node 环境）

## 理解 script 整体代码块是宏任务

实际上如果同时存在两个 script 代码块，会首先在执行第一个 script 代码块中的同步代码，如果这个过程中创建了微任务并进入了微任务队列，第一个 script 同步代码执行完之后，会首先去清空微任务队列，再去开启第二个 script 代码块的执行

## 执行顺序

1. 首先执行主线程上的同步任务
2. 遇到异步代码时，如果是宏任务（如 setTimeout/setInterval），则将其放入宏任务队列；如果是微任务（如 Promise.then/nextTick），则将其放入微任务队列
3. 当主线程上的同步代码执行完毕后，在 Event Loop 开始之前，会先检查微任务队列，如果有未执行的微任务，则依次执行完所有的微任务
4. 然后再检查 DOM 渲染，如果有需要更新的 DOM，则进行渲染
5. 最后再从宏任务队列中取出一个宏任务并执行，然后重复上述过程（

注：步骤 5 中重复上述过程意味着执行完该宏任务后，若有微任务加入则会先执行新加入的微任务，经过 1-4 步骤后再检索下一个宏任务
