# diff  算法

## 概念

diff 算法是一种用于比较虚拟 DOM 树的变化，并且尽可能高效地更新真实 DOM 的技术

## 时间复杂度

O(n)

## 手写 diff

1. vnode()：构造虚拟节点的 js 对象

2. h()：创建虚拟节点。***根据传入的参数类型，结合 vnode() 去构建虚拟节点的 js 对象***。可能的传参方式：

   ```js
   1. 基本数据类型：h('div', {}, 'xxx') // 元素选择器，元素属性，基本数据类型
   2. 数组子节点：h('div', {}, [{h(xxx)}, {h(xxx)}])
   3. 单一子节点：h('div', {}, h(xxx) )
   4. 可能存在其他传参类型，本手写的 diff 算法只实现以上三种
   ```

3. ***patch()\****：比对新老节点，按照替换规则更新虚拟 DOM，转换为真实 DOM 后渲染到页面

   1. patchSameVnode()：处理新老节点为同一个节点时的情况
   2. ***updateChildren()\****：处理新老节点都有子节点时的情况
   3. createElement()：将虚拟 DOM 创建为真实 DOM

## 替换规则*

1. 只能同级比较，不能跨级比较。如果跨层则暴力删除老节点创建新节点
2. 新老节点不为同一节点（***依据：选择器相同、key 存在且相同***）时，则暴力删除老节点创建新节点
3. 新老节点为同一节点时，分为多种情况：
   1. 如果新节点没有子节点，则证明节点是文本，直接将老节点替换为文本
   2. 如果新节点有子节点，老节点没有子节点，则将老节点内容清空，添加新节点
   3. 如果新老节点都有子节点   (***diff 算法核心***)
      1. 定义四个指针
      2. 遍历节点，按照规则对节点进行查找。匹配规则时（为同一个节点），修改指针并进行替换
         1. 老前 VS 新前。匹配则老前指针++，新前指针++
         2. 老后 VS 新后。匹配则老后指针--，新后指针--
         3. 老前 VS 新后。匹配则老前指针++，新后指针--。将该节点移动到老后之后
         4. 老后 VS 新前。匹配则老后指针--，新前指针++。将该节点移动到老前之前
         5. 不满足前 4 种条件时，在剩余老节点中遍历查找新前指向节点
            1. 存在，则将该节点移动到老前之前
            2. 不存在，则创建该节点到老前之前
         6. 不满足前五种条件时，创建新节点，新前指针++
         7. 当新老节点个数不一样时，对比指针位置判断添加或删除
            1. 新节点有剩余节点时 - 添加：依次将剩余节点插入到新后之后
            2. 老节点有剩余节点时 - 删除：依次将剩余节点删除
      3. 匹配规则时，不再继续按照其他规则查找

## diff 算法中 key 的作用

key 是唯一标识，可以判断新老节点是否为同一个节点，从而进行细致的 diff 算法计算。若无 key，则直接证明新老节点不是同一节点，直接进行暴力删除和添加，浪费性能
