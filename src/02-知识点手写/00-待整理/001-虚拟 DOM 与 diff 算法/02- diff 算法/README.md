# diff算法替换规则

1. 只能同级比较，不能跨级比较。如果跨层则暴力删除老节点创建新节点
2. 新老节点不为同一节点时，则暴力删除老节点创建新节点
3. 新老节点为同一节点时，分为多种情况：
   1. 如果新节点没有children，则证明节点是文本，直接将老节点替换为文本
   2. 如果新节点有children，老节点没有children，则将老节点内容清空，添加新节点
   3. 如果新节点有children，老节点也有children   (__diff算法核心__)
      1. 老前 VS 新前。匹配则老前指针++，新前指针++
      2. 老后 VS 新后。匹配则老后指针--，新后指针--
      3. 老前 VS 新后。匹配则老前指针++，新后指针--。把老前指定的节点移动到老后指向节点的后面
      4. 老后 VS 新前。匹配则老后指针--，新前指针++。把老后指定的节点移动到老前指向节点的前面
      5. 不满足前四种条件时，在老节点中查找是否存在新节点，匹配则把该节点移动到老前指向节点的前面，并将老节点中与之对应的节点设为undefined
      6. 不满足前五种条件时，创建新节点，新前指针++
4. *注：每对一个子节点进行替换时都要按照 1-3 的替换规则查看是否符合条件并进行替换*
5. *注：如果要提升性能，一定要加入key，key是唯一标识，在更改前后确认是不是同一个节点，如果不加key，则全部直接暴力删除暴力添加*

# 手写diff算法思路

## 第一步：创建虚拟DOM

### h()
1. 确定传入的参数为`sel, data, params`
2. 判断params是否为数组
   1. 当params不为数组时，证明没有子节点，则传入vnode()相应参数`sel, data, undefined, params, undefined`
   2. 当params为数组时，证明有子节点，遍历params获取所有子元素，则传入vnode()相应参数`sel, data, children, undefined, undefined`

### vnode()
1. 将传入的值集成到对象中并进行返回，生成虚拟DOM

## 第二步：比对新老节点及其子节点，并根据比对结果按照替换规则创建真实DOM

### patch()
1. 明确patch()传入的参数为`oldVnode, newVnode`，第一次传入的oldVnode为真实节点
2. 判断老节点是否为虚拟节点，若不是虚拟节点则通过vnode()将其转换为虚拟节点，方便后期节点的替换
3. 判断老节点和新节点是否为同一个节点，因为根据替换规则，当不为同一个节点时暴力删除老节点创建新节点
4. 当不为同一个节点时：
   1. 创建新节点，通过createELement()创建DOM节点，再插入到页面中
   2. 删除老节点，通过oldVnode.elm获取老节点进行删除
5. 当为同一个节点时，分多种情况(通过patchVnode()实现)

### createELement()
1. 根据虚拟节点中的sel属性创建对于的DOM节点
2. 判断是否有子节点
   1. 如果没有子节点则将字符串赋值
   2. 如果有子节点则通过递归创建子节点
3. 补充elm属性

### patchNode()
1. 判断新节点是否有子节点，如果新节点没有子节点，则证明节点是文本，直接将老节点替换为文本
2. 如果新节点有子节点，老节点没有子节点，则将老节点内容清空，添加新节点
3. 如果新节点有子节点，老节点也有子节点，分多种情况(通过updateChildren()实现)

### updateChildren() __难点__

# 待完善

## 不进行真实DOM的patch处理直接patch虚拟DOM时elm挂载失败(TODO)